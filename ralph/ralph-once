#!/bin/bash
# ralph-once - Run a single iteration of agentic coding
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Help text
show_help() {
    echo -e "${BLUE}ralph-once${NC} - Single iteration agentic coding"
    echo ""
    echo "Usage: ralph-once [options]"
    echo ""
    echo "Options:"
    echo "  -p, --prd <file>     PRD file (default: plans/prd.json)"
    echo "  -r, --progress <file> Progress file (default: progress.txt)"
    echo "  -c, --ci <command>   CI command (default: auto-detect)"
    echo "  -h, --help           Show this help"
    echo ""
}

# Auto-detect CI command (same as main ralph script)
detect_ci() {
    if [ -f "package.json" ]; then
        if grep -q '"typecheck"' package.json 2>/dev/null; then
            if grep -q '"test"' package.json 2>/dev/null; then
                if [ -f "pnpm-lock.yaml" ]; then
                    echo "pnpm typecheck && pnpm test"
                elif [ -f "bun.lockb" ]; then
                    echo "bun run typecheck && bun test"
                elif [ -f "yarn.lock" ]; then
                    echo "yarn typecheck && yarn test"
                else
                    echo "npm run typecheck && npm test"
                fi
                return
            fi
        fi
        if grep -q '"test"' package.json 2>/dev/null; then
            if [ -f "pnpm-lock.yaml" ]; then
                echo "pnpm test"
            elif [ -f "bun.lockb" ]; then
                echo "bun test"
            elif [ -f "yarn.lock" ]; then
                echo "yarn test"
            else
                echo "npm test"
            fi
            return
        fi
    fi
    if [ -f "pyproject.toml" ] || [ -f "setup.py" ]; then
        if [ -f "pytest.ini" ] || [ -d "tests" ]; then
            echo "pytest"
            return
        fi
    fi
    if [ -f "go.mod" ]; then
        echo "go test ./..."
        return
    fi
    if [ -f "Cargo.toml" ]; then
        echo "cargo test"
        return
    fi
    echo ""
}

# Default values
PRD_FILE="plans/prd.json"
PROGRESS_FILE="progress.txt"
CI_COMMAND=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--prd)
            PRD_FILE="$2"
            shift 2
            ;;
        -r|--progress)
            PROGRESS_FILE="$2"
            shift 2
            ;;
        -c|--ci)
            CI_COMMAND="$2"
            shift 2
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            show_help
            exit 1
            ;;
    esac
done

# Validate PRD exists
if [ ! -f "$PRD_FILE" ]; then
    echo -e "${RED}Error: PRD file not found: $PRD_FILE${NC}"
    echo "Run 'ralph init' to create one."
    exit 1
fi

# Auto-detect CI if not specified
if [ -z "$CI_COMMAND" ]; then
    CI_COMMAND=$(detect_ci)
fi

# Build CI instruction
CI_INSTRUCTION=""
if [ -n "$CI_COMMAND" ]; then
    CI_INSTRUCTION="2. Check that CI passes via: $CI_COMMAND"
else
    CI_INSTRUCTION="2. If the project has tests or type checking, verify they pass."
fi

echo -e "${BLUE}ralph-once${NC} - Single iteration"
echo -e "PRD: ${YELLOW}$PRD_FILE${NC} | CI: ${YELLOW}${CI_COMMAND:-auto}${NC}"
echo ""

claude --permission-mode acceptEdits -p "@$PRD_FILE @$PROGRESS_FILE \
1. Find the highest-priority feature to work on and work only on that feature. \
This should be the one YOU decide has the highest priority - not necessarily the first in the list. \
$CI_INSTRUCTION \
3. Update the PRD with the work that was done (set passes: true for completed items). \
4. Append your progress to the $PROGRESS_FILE file. \
Use this to leave a note for the next person working in the codebase. \
5. Make a git commit of that feature. \
ONLY WORK ON A SINGLE FEATURE. \
If, while implementing the feature, you notice the PRD is complete, output <promise>COMPLETE</promise>. \
"

